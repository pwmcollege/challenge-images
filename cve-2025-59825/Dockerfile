FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y \
    build-essential \
    ca-certificates \
    curl \
    tar && \
    rm -rf /var/lib/apt/lists/*

ENV CARGO_HOME=/opt/cargo
ENV RUSTUP_HOME=/opt/rustup
ENV PATH="/opt/cargo/bin:${PATH}"

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path

COPY Cargo.toml /tmp/Cargo.toml
COPY main.rs /tmp/src/main.rs

RUN cd /tmp && \
    cargo add \
    astral-tokio-tar@=0.5.3 \
    futures \
    rustc-hash \
    tokio --features "tokio/macros,tokio/rt-multi-thread" && \
    cargo build --release && \
    cargo clean && \
    rm -rf /tmp/*

RUN ln -s /etc/bash.bashrc /etc/bashrc && \
    if id ubuntu; then userdel -f -r ubuntu; fi && \
    find / -xdev -type f -perm -4000 -exec chmod u-s {} \;
